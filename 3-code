import argparse
import sys
from functools import lru_cache

import cv2
import numpy as np

from picamera2 import MappedArray, Picamera2
from picamera2.devices import IMX500
from picamera2.devices.imx500 import (NetworkIntrinsics, postprocess_nanodet_detection)
import RPi.GPIO as GPIO
import time

# ØªØ¹Ø±ÙŠÙ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù€ GPIO Ù„ÙƒÙ„ Ù„ÙˆÙ† ÙÙŠ Ø§Ù„Ø¥Ø´Ø§Ø±Ø©
RED_LIGHT = 17
YELLOW_LIGHT = 27
GREEN_LIGHT = 22

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù€ GPIO
GPIO.setmode(GPIO.BCM)
GPIO.setup(RED_LIGHT, GPIO.OUT)
GPIO.setup(YELLOW_LIGHT, GPIO.OUT)
GPIO.setup(GREEN_LIGHT, GPIO.OUT)

# ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¶ÙˆØ¡ Ø§Ù„Ø£Ø­Ù…Ø± Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§ Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
GPIO.output(RED_LIGHT, GPIO.HIGH)
GPIO.output(YELLOW_LIGHT, GPIO.LOW)
GPIO.output(GREEN_LIGHT, GPIO.LOW)

def set_traffic_light(color):
    GPIO.output(RED_LIGHT, GPIO.LOW)
    GPIO.output(YELLOW_LIGHT, GPIO.LOW)
    GPIO.output(GREEN_LIGHT, GPIO.LOW)

    if color == "red":
        GPIO.output(RED_LIGHT, GPIO.HIGH)
    elif color == "yellow":
        GPIO.output(YELLOW_LIGHT, GPIO.HIGH)
    elif color == "green":
        GPIO.output(GREEN_LIGHT, GPIO.HIGH)

def turn_green_light():
    print("ğŸš¦ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø§Ù„Ø®Ø¶Ø±Ø§Ø¡!")
    set_traffic_light("green")
    time.sleep(5)  # Ø¥Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ø¶ÙˆØ¡ Ø§Ù„Ø£Ø®Ø¶Ø± Ù„Ù…Ø¯Ø© 5 Ø«ÙˆØ§Ù†Ù

    print("ğŸŸ¡ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø£ØµÙØ±!")
    set_traffic_light("yellow")
    time.sleep(2)  # Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£ØµÙØ± Ù„ÙØªØ±Ø© ÙˆØ¬ÙŠØ²Ø©

    print("ğŸ”´ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø­Ù…Ø±!")
    set_traffic_light("red")

last_detections = []

class Detection:
    def __init__(self, coords, category, conf, metadata):
        """Create a Detection object, recording the bounding box, category and confidence."""
        self.category = category
        self.conf = conf
        self.box = imx500.convert_inference_coords(coords, metadata, picam2)

def get_labels():
    labels = intrinsics.labels
    if intrinsics.ignore_dash_labels:
        labels = [label for label in labels if label and label != "-"]
    
    # Ø·Ø¨Ø§Ø¹Ø© Ù…Ø­ØªÙˆÙŠØ§Øª labels
    print(f"Ø§Ù„ÙØ¦Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©: {labels}")  # Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙØ¦Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©

    return labels

def parse_detections(metadata: dict):
    """Parse the output tensor into a number of detected objects, scaled to the ISP output."""
    global last_detections
    bbox_normalization = intrinsics.bbox_normalization
    bbox_order = intrinsics.bbox_order
    threshold = args.threshold
    iou = args.iou
    max_detections = args.max_detections

    np_outputs = imx500.get_outputs(metadata, add_batch=True)
    input_w, input_h = imx500.get_input_size()
    if np_outputs is None:
        return last_detections

    if intrinsics.postprocess == "nanodet":
        boxes, scores, classes = \
            postprocess_nanodet_detection(outputs=np_outputs[0], conf=threshold, iou_thres=iou,
                                          max_out_dets=max_detections)[0]
        from picamera2.devices.imx500.postprocess import scale_boxes
        boxes = scale_
